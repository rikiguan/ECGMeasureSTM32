#include "firProcess.h"
#include "stdint.h"
#include "arm_math.h"
#include "stdio.h" 

#include <stdlib.h>

//TODO Q15方式存在bug
int BL = 98;
int16_t B[99] = {
     -227,   -192,    116,    -57,     18,    -15,     61,   -142,    222,
     -249,    191,    -62,    -85,    179,   -181,    108,    -22,     -4,
      -52,    142,   -173,     70,    166,   -431,    573,   -479,    158,
      252,   -550,    594,   -389,     96,     73,      0,   -240,    402,
     -220,   -392,   1225,  -1826,   1724,   -719,   -937,   2579,  -3416,
     2925,  -1152,  -1251,   3290,  28683,   3290,  -1251,  -1152,   2925,
    -3416,   2579,   -937,   -719,   1724,  -1826,   1225,   -392,   -220,
      402,   -240,      0,     73,     96,   -389,    594,   -550,    252,
      158,   -479,    573,   -431,    166,     70,   -173,    142,    -52,
       -4,    -22,    108,   -181,    179,    -85,    -62,    191,   -249,
      222,   -142,     61,    -15,     18,    -57,    116,   -192,   -227
};

int16_t pState[500] = {0.0f}; // FIR滤波器状态变量暂存：数组的大小=BL+blocksize-1


arm_fir_instance_q15 *S; // FIR实例化结构体

void firProcessQ15(int16_t *fir_inputbuf, int16_t *fir_outputbuf,uint32_t blockSize)
{

  S = (arm_fir_instance_q15 *)malloc(sizeof(arm_fir_instance_q15)); // 开辟一个空间S
  if (S == NULL)                                                    // 如果开辟失败则报错
  {
    printf("error\r\n");
  }

  arm_fir_init_q15(S, BL, B, pState, blockSize);
  arm_fir_q15(S, fir_inputbuf, fir_outputbuf, blockSize);

  free(S);  // 释放内存
  S = NULL; // 将指针设置为 NULL，以避免悬挂指针
}


int FBL = 99;
float FB[99] = {
  -0.006920771673,-0.005854468793, 0.003539241618,-0.001735856407,0.0005518746329,
  -0.0004703555314, 0.001848580665,-0.004345260561, 0.006769695785,-0.007588313427,
   0.005837508012,-0.001881849254, -0.00259122951, 0.005473582074, -0.00553707825,
   0.003282360034,-0.0006846527685,-0.0001237177785,-0.001572518144, 0.004328998271,
   -0.00528990943, 0.002122428967, 0.005057914183, -0.01314096991,  0.01747161895,
   -0.01462368015, 0.004816357512, 0.007696946617,  -0.0167980697,   0.0181174539,
   -0.01186721679, 0.002920154249,  0.00223860587,5.879381604e-08,-0.007331552915,
    0.01226248499,-0.006712560076, -0.01196956262,  0.03738544881,  -0.0557234548,
    0.05262221023, -0.02194123529, -0.02858500928,  0.07869827747,   -0.104250662,
     0.0892663151, -0.03515248746, -0.03816326708,   0.1003892273,     0.87534374,
     0.1003892273, -0.03816326708, -0.03515248746,   0.0892663151,   -0.104250662,
    0.07869827747, -0.02858500928, -0.02194123529,  0.05262221023,  -0.0557234548,
    0.03738544881, -0.01196956262,-0.006712560076,  0.01226248499,-0.007331552915,
  5.879381604e-08,  0.00223860587, 0.002920154249, -0.01186721679,   0.0181174539,
    -0.0167980697, 0.007696946617, 0.004816357512, -0.01462368015,  0.01747161895,
   -0.01314096991, 0.005057914183, 0.002122428967, -0.00528990943, 0.004328998271,
  -0.001572518144,-0.0001237177785,-0.0006846527685, 0.003282360034, -0.00553707825,
   0.005473582074, -0.00259122951,-0.001881849254, 0.005837508012,-0.007588313427,
   0.006769695785,-0.004345260561, 0.001848580665,-0.0004703555314,0.0005518746329,
  -0.001735856407, 0.003539241618,-0.005854468793,-0.006920771673
};
float fpState[500] = {0.0f}; // FIR滤波器状态变量暂存：数组的大小=BL+blocksize-1
arm_fir_instance_f32 *FS; // FIR实例化结构体
void firProcessFT(float *fir_inputbuf, float *fir_outputbuf,uint32_t blockSize)
{

  FS = (arm_fir_instance_f32 *)malloc(sizeof(arm_fir_instance_f32)); // 开辟一个空间S
  if (S == NULL)                                                    // 如果开辟失败则报错
  {
    printf("error\r\n");
  }

  arm_fir_init_f32(FS, FBL, FB, fpState, blockSize);
  arm_fir_f32(FS, fir_inputbuf, fir_outputbuf, blockSize);

  free(FS);  // 释放内存
  FS = NULL; // 将指针设置为 NULL，以避免悬挂指针
}
